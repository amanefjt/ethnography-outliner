# 実装計画：高度なグループ化と関係線の最適化

## 変更対象リスト
- `main.js`: `calculateRelationCoordinates` (座標計算), `renderQuickActions` (UI制御), `moveGroupAndChildren` (移動ロジック)

## 設計方針

### 1. 関係線をエッジから出す (Rationale)
現在は要素の中心点同士を結んでいますが、これでは線の一部が要素の下に隠れてしまいます。
- **解決策**: 中心点同士を結ぶベクトルが要素の矩形境界と交差する点を計算します。
- **計算手法**: 要素の幅・高さ、中心座標に基づき、ターゲットへの角度から矩形の辺上の交点を求めます。

### 2. 多量アイテムのグループ化
- **解決策**: `renderQuickActions` における `state.selectedIds.length` のチェック条件を調整します。
- `state.selectedIds.length >= 2` の場合にグループ化ボタンを表示するようにし、件数によらず一括処理可能にします。

### 3. ネストされたグループの連動移動 (Rationale)
- **解決策**: ドラッグ中の移動量 `dx`, `dy` を、再帰的関数 `moveGroupAndChildren` に確実に伝播させます。
- 階層構造が変わっても「相対的な移動」が維持されるよう、ループ内での状態更新順序に注意します。
- `endDrag` 時の境界更新を再帰的に行い、親の親までサイズが正しく追従するようにします。

## 設計を選んだ根拠 (Rationale)
- **視覚的な明快さ**: エッジからの接続は、フロー図やマインドマップとしての可読性を大幅に向上させます。
- **操作の柔軟性**: 3つ以上のアイテムを一度にまとめられることで、大規模な整理作業の効率が上がります。
- **データ構造の整合性**: 再帰的な移動ロジックを採用することで、グループの階層が深くなっても例外処理なしで一貫した挙動を保証できます。
