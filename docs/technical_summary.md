# Ethnography Outliner 技術仕様書

## 1. プロジェクト概要
本アプリケーションは、フィールドワークやインタビューで得られた定性的データを、カード形式で視覚的に整理・構造化するための「無限キャンバス型アウトライナー」です。
ユーザーはテキストデータをインポートし、カードとして配置、グループ化、関係付けを行うことで、データの意味的構造を見出すことができます。

## 2. アーキテクチャ
- **Frontend Only**: サーバー処理を必要としない、HTML/CSS/Vanilla JSのみで構成されたシングルページアプリケーション（SPA）。
- **Data Persistence**: ブラウザの `localStorage` を使用し、データはすべてローカルに保存されます。ページをリロードしても状態は維持されます。
- **No Dependencies**: 外部ライブラリはアイコン表示用の `Lucide` のみ。フレームワーク（React/Vue等）は不使用。

## 3. 主要機能と仕様

### 3.1 データ構造 (State)
アプリケーションの状態は単一の `state` オブジェクトで管理されます。
```javascript
state = {
    notes: [],      // ノート（カード）の配列
    groups: [],     // グループの配列
    relations: [],  // ノート/グループ間の関係（リンク）
    selection: [],  // 現在選択されているアイテムID
    zoom: 1,        // キャンバスのズームレベル
    offset: {x, y}, // キャンバスのパン（移動）位置
    history: { ... } // Undo/Redo用の履歴スタック
}
```

### 3.2 無限キャンバス (Infinite Canvas)
- **操作**: スペースキー+ドラッグ、またはホイールでパン・ズームが可能。
- **座標系**: 仮想的な無限平面上にアイテムを配置し、CSSの `transform` でビューポートを制御。

### 3.3 ノート (Note)
- **作成**: 新規作成ボタン、またはダブルクリック。タイトル（任意）と本文を持つ。
- **属性**: 色変更、折りたたみ（タイトルのみ表示）、最大化（モーダル表示）、複製、削除が可能。
- **ID表示**: カード左下に薄くIDを表示（デバッグ兼参照用）。

### 3.4 グループ (Group)
- **構造**: 再帰的な入れ子構造をサポート。グループの中にグループを入れることが可能。
- **自動削除**: 要素が0個または1個しか含まれない冗長なグループは自動的に削除・解除される（Cleanup Logic）。
- **ドラッグ挙動**: グループをドラッグすると、含まれる子要素も追従して移動する。

### 3.5 関係性 (Relation)
- **描画**: SVGを使用し、アイテム間の最短距離を計算して直線を引く。
- **交点計算**: アイテムの境界線（矩形）と中心を結ぶ線の交点を数学的に算出し、線がアイテムの下に隠れたり離れすぎたりしないよう制御。
- **属性**: ラベル付けが可能。ラベル入力欄と削除機能（ラベルのダブルクリック）を持つ。

### 3.6 インポート (Import)
- **Markdown解析**:
  - 行頭のハッシュ(`#`)やハイフン(`-`)を解析し、インデント構造を読み取る。
  - **親ブレット**: カードの「タイトル」として扱われる。
  - **子ブレット**: カードの「本文」として結合される。
  - **フラットな行**: 空行区切りで個別のカードとして扱われる。
- **図解**: インポートモーダルにて、変換ロジックを視覚的に提示。

### 3.7 ヒストリー (Undo/Redo)
- **実装**: 操作ごとに `state` 全体のスナップショットをJSON化してスタックに保存。
- **制限**: 最大50ステップまで保持。

## 4. ファイル構成とモジュール
コードの保守性を高めるため、以下の役割でモジュール分割を行う（予定）。

- `js/constants.js`: 定数定義（サイズ、色、設定値）
- `js/state.js`: データの保持、保存、読み込み、履歴管理
- `js/utils.js`: 幾何計算、HTMLエスケープ等のヘルパー関数
- `js/render.js`: キャンバス、アイテム、SVGの描画ロジック
- `js/interactions.js`: ドラッグ＆ドロップ、イベントリスナー定義
- `js/app.js`: アプリケーションの初期化と統合

## 5. 今後の拡張性
- **ファイル出力**: JSON/Markdown形式でのエクスポート機能。
- **検索**: ノート内容の全文検索。
- **画像対応**: カードへの画像貼り付け。
